<h3 style="padding-bottom:6px; padding-left:20px; color:#ffffff; background-color:#E74C3C;">一、2PC协议</h3>

> 2PC 是 *Two-Phase Commit Protocol* 的缩写，中文名称 **两阶段提交协议**，它是为了解决 *分布式事务一致性* 问题而产生的算法。分布式一致性问题是分布式系统各个节点（分区）如何就一项决议达成一致的问题，构成的一组操作称为**事务** （又称 **分布式事务**）。

两阶段提交协议是指事务提交的过程分为两个阶段：**准备阶段** 和 **提交阶段**。其中事务的发起者称 **协调者** ，事务的执行者称 **参与者** 。一般，在一个事务中有一个协调者和多个参与者。

![2PC]()

#### 准备阶段：

首先，协调者询问事务中各个参与者是否可以执行操作。然后，事务中的各个参与者执行操作（占有资源）并做出回答YES/NO给协调者；

#### 提交阶段：

最后，协调者检查事务中的各个参与者的反馈，全部反馈YES则做事务提交，否则存在NO则做事务回滚。



#### 下面通过一个案例来说明：

**背景**：比如某用户想从杭州去巴黎，但杭州没有直达巴黎的机票，他想先从杭州转到北京，然后从北京飞往巴黎。

他想通过携程APP进行购买两张票，要么两张票都购买成功，要么两张票都购买失败。

**过程**：首先用户先通过携程选择杭州到北京、北京到巴黎的机票；如果两个航班都有机票话，然后下单购买两个航班的机票。

**分析**：整个购买两张机票的过程就是一个事务，分别购买两个班次的行为就是两个操作。

准备阶段：选择航班机票时就是准备阶段，被选择的航空公司票务系统就是参与者，通过选择机票就是占有资源(占有资源是有时间限制的)；

![准备阶段]()

提交阶段：携程作为协调者会查看参与者(各航空公司票务系统)是否可以提供机票，如果都是YES，表示可以提交订单，否则有NO，只能放弃操作(事务回滚)，也是放弃对资源的占有。

![提交阶段]()



#### 2PC的缺陷：

**同步阻塞**：我们前面讲过，2PC协议就是为了解决分布式事务一致性问题的，而可用性与一致性往往存在矛盾。假设分区节点之间出现网络通信问题，那么消息就不能及时传递给响应的节点，为了到达一致性，整个分布式系统(准确地将是参与事务的机器组成的系统)将会陷入阻塞状态，所以2PC协议是一个典型的 **阻塞式协议**。

**单点问题**：如果协调者出现故障，参与者将一直处在等待状态(等待协调者发送消息指令)，被占有资源也不能释放，这就会协调者的单点问题。

**脑裂问题**：在提交阶段中，只有部分参与者接收到协调发送的commit指令，则会出现数据不一致的问题。

---

<h3 style="padding-bottom:6px; padding-left:20px; color:#ffffff; background-color:#E74C3C;">二、3PC协议</h3>

> 3PC 是 *Three-Phase Commit Protocol* 的缩写，中文名称 **三阶段提交协议**，它为了解决2PC问题而产生的改进版本的分布式一致性协议。
>
> 在原来2PC协议的基础上，将2阶段扩展到3阶段：**能否提交阶段**、**PreCommit阶段**、**DoCommit阶段**。

#### 能否提交阶段（CanCommit）：



#### 预提交阶段（PreCommit）：



#### 提交阶段（DoCommit）：

